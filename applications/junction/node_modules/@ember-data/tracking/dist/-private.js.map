{"version":3,"file":"-private.js","sources":["../src/-private.ts"],"sourcesContent":["import { tagForProperty } from '@ember/-internals/metal';\nimport { consumeTag, dirtyTag } from '@glimmer/validator';\n\nimport { DEPRECATE_COMPUTED_CHAINS } from '@warp-drive/build-config/deprecations';\nimport { DEBUG } from '@warp-drive/build-config/env';\nimport { getOrSetGlobal, peekTransient, setTransient } from '@warp-drive/core-types/-private';\n\n/**\n * This package provides primitives that allow powerful low-level\n * adjustments to change tracking notification behaviors.\n *\n * Typically you want to use these primitives when you want to divorce\n * property accesses on EmberData provided objects from the current\n * tracking context. Typically this sort of thing occurs when serializing\n * tracked data to send in a request: the data itself is often ancillary\n * to the thing which triggered the request in the first place and you\n * would not want to re-trigger the request for any update to the data.\n *\n * @module @ember-data/tracking\n * @main @ember-data/tracking\n */\ntype OpaqueFn = (...args: unknown[]) => unknown;\ntype Tag = { ref: null; t: boolean };\ntype Transaction = {\n  cbs: Set<OpaqueFn>;\n  props: Set<Tag | Signal>;\n  sub: Set<Tag | Signal>;\n  parent: Transaction | null;\n};\n\nfunction createTransaction() {\n  const transaction: Transaction = {\n    cbs: new Set(),\n    props: new Set(),\n    sub: new Set(),\n    parent: null,\n  };\n  const TRANSACTION = peekTransient<Transaction>('TRANSACTION');\n\n  if (TRANSACTION) {\n    transaction.parent = TRANSACTION;\n  }\n  setTransient('TRANSACTION', transaction);\n}\n\nfunction maybeConsume(tag: ReturnType<typeof tagForProperty> | null): void {\n  if (tag) {\n    consumeTag(tag);\n  }\n}\n\nfunction maybeDirty(tag: ReturnType<typeof tagForProperty> | null): void {\n  if (tag) {\n    // @ts-expect-error - we are using Ember's Tag not Glimmer's\n    dirtyTag(tag);\n  }\n}\n\n/**\n * If there is a current transaction, ensures that the relevant tag (and any\n * array computed chains symbols, if applicable) will be consumed during the\n * transaction.\n *\n * If there is no current transaction, will consume the tag(s) immediately.\n *\n * @internal\n * @param obj\n */\nexport function subscribe(obj: Tag | Signal): void {\n  const TRANSACTION = peekTransient<Transaction | null>('TRANSACTION');\n\n  if (TRANSACTION) {\n    TRANSACTION.sub.add(obj);\n  } else if ('tag' in obj) {\n    if (DEPRECATE_COMPUTED_CHAINS) {\n      maybeConsume(obj['[]']);\n      maybeConsume(obj['@length']);\n    }\n    consumeTag(obj.tag);\n  } else {\n    // eslint-disable-next-line @typescript-eslint/no-unused-expressions\n    obj.ref;\n  }\n}\n\nfunction updateRef(obj: Tag | Signal): void {\n  if (DEBUG) {\n    try {\n      if ('tag' in obj) {\n        if (DEPRECATE_COMPUTED_CHAINS) {\n          maybeDirty(obj['[]']);\n          maybeDirty(obj['@length']);\n        }\n        // @ts-expect-error - we are using Ember's Tag not Glimmer's\n        dirtyTag(obj.tag);\n      } else {\n        obj.ref = null;\n      }\n    } catch (e: unknown) {\n      if (e instanceof Error) {\n        if (e.message.includes('You attempted to update `undefined`')) {\n          // @ts-expect-error\n          const key = `<${obj._debug_base}>.${obj.key}`;\n          e.message = e.message.replace('You attempted to update `undefined`', `You attempted to update ${key}`);\n          e.stack = e.stack?.replace('You attempted to update `undefined`', `You attempted to update ${key}`);\n\n          const lines = e.stack?.split(`\\n`);\n          const finalLines: string[] = [];\n          let lastFile: string | null = null;\n\n          lines?.forEach((line) => {\n            if (line.trim().startsWith('at ')) {\n              // get the last string in the line which contains the code source location\n              const location = line.split(' ').at(-1)!;\n              // remove the line and char offset info\n\n              if (location.includes(':')) {\n                const parts = location.split(':');\n                parts.pop();\n                parts.pop();\n                const file = parts.join(':');\n                if (file !== lastFile) {\n                  lastFile = file;\n                  finalLines.push('');\n                }\n              }\n              finalLines.push(line);\n            }\n          });\n\n          const splitstr = '`undefined` was first used:';\n          const parts = e.message.split(splitstr);\n          parts.splice(1, 0, `Original Stack\\n=============\\n${finalLines.join(`\\n`)}\\n\\n\\`${key}\\` was first used:`);\n\n          e.message = parts.join('');\n        }\n      }\n      throw e;\n    }\n  } else {\n    if ('tag' in obj) {\n      if (DEPRECATE_COMPUTED_CHAINS) {\n        maybeDirty(obj['[]']);\n        maybeDirty(obj['@length']);\n      }\n      // @ts-expect-error - we are using Ember's Tag not Glimmer's\n      dirtyTag(obj.tag);\n    } else {\n      obj.ref = null;\n    }\n  }\n}\n\nfunction flushTransaction() {\n  const transaction = peekTransient<Transaction>('TRANSACTION')!;\n  setTransient('TRANSACTION', transaction.parent);\n  transaction.cbs.forEach((cb) => {\n    cb();\n  });\n  transaction.props.forEach((obj) => {\n    // mark this mutation as part of a transaction\n    obj.t = true;\n    updateRef(obj);\n  });\n  transaction.sub.forEach((obj) => {\n    if ('tag' in obj) {\n      if (DEPRECATE_COMPUTED_CHAINS) {\n        maybeConsume(obj['[]']);\n        maybeConsume(obj['@length']);\n      }\n      consumeTag(obj.tag);\n    } else {\n      // eslint-disable-next-line @typescript-eslint/no-unused-expressions\n      obj.ref;\n    }\n  });\n}\nasync function untrack() {\n  const transaction = peekTransient<Transaction>('TRANSACTION')!;\n  setTransient('TRANSACTION', transaction.parent);\n\n  // defer writes\n  await Promise.resolve();\n  transaction.cbs.forEach((cb) => {\n    cb();\n  });\n  transaction.props.forEach((obj) => {\n    // mark this mutation as part of a transaction\n    obj.t = true;\n    updateRef(obj);\n  });\n}\n\nexport function addToTransaction(obj: Tag | Signal): void {\n  const transaction = peekTransient<Transaction>('TRANSACTION');\n\n  if (transaction) {\n    transaction.props.add(obj);\n  } else {\n    updateRef(obj);\n  }\n}\nexport function addTransactionCB(method: OpaqueFn): void {\n  const transaction = peekTransient<Transaction>('TRANSACTION');\n\n  if (transaction) {\n    transaction.cbs.add(method);\n  } else {\n    method();\n  }\n}\n\n/**\n * Run `method` without subscribing to any tracked properties\n * controlled by EmberData.\n *\n * This should rarely be used except by libraries that really\n * know what they are doing. It is most useful for wrapping\n * certain kinds of fetch/query logic from within a `Resource`\n * `hook` or other similar pattern.\n *\n * @function untracked\n * @public\n * @static\n * @for @ember-data/tracking\n * @param method\n * @return result of invoking method\n */\nexport function untracked<T extends OpaqueFn>(method: T): ReturnType<T> {\n  createTransaction();\n  const ret = method();\n  void untrack();\n  return ret as ReturnType<T>;\n}\n\n/**\n * Run the method, subscribing to any tracked properties\n * managed by EmberData that were accessed or written during\n * the method's execution as per-normal but while allowing\n * interleaving of reads and writes.\n *\n * This is useful when for instance you want to perform\n * a mutation based on existing state that must be read first.\n *\n * @function transact\n * @public\n * @static\n * @for @ember-data/tracking\n * @param method\n * @return result of invoking method\n */\nexport function transact<T extends OpaqueFn>(method: T): ReturnType<T> {\n  createTransaction();\n  const ret = method();\n  flushTransaction();\n  return ret as ReturnType<T>;\n}\n\n/**\n * A helpful utility for creating a new function that\n * always runs in a transaction. E.G. this \"memoizes\"\n * calling `transact(fn)`, currying args as necessary.\n *\n * @method memoTransact\n * @public\n * @static\n * @for @ember-data/tracking\n * @param method\n * @return a function that will invoke method in a transaction with any provided args and return its result\n */\nexport function memoTransact<T extends OpaqueFn>(method: T): (...args: unknown[]) => ReturnType<T> {\n  return function (...args: unknown[]) {\n    createTransaction();\n    const ret = method(...args);\n    flushTransaction();\n    return ret as ReturnType<T>;\n  };\n}\n\nexport const Signals = getOrSetGlobal('Signals', Symbol('Signals'));\n\n/**\n *  use to add a signal property to the prototype of something.\n *\n *  First arg is the thing to define on\n *  Second arg is the property name\n *  Third agg is the initial value of the property if any.\n *\n *  for instance\n *\n *  ```ts\n *  class Model {}\n *  defineSignal(Model.prototype, 'isLoading', false);\n *  ```\n *\n *  This is sort of like using a stage-3 decorator but works today\n *  while we are still on legacy decorators.\n *\n *  e.g. it is equivalent to\n *\n *  ```ts\n *  class Model {\n *    @signal accessor isLoading = false;\n *  }\n *  ```\n *\n *  @internal\n */\nexport function defineSignal<T extends object>(obj: T, key: string, v?: unknown) {\n  Object.defineProperty(obj, key, {\n    enumerable: true,\n    configurable: false,\n    get(this: T & { [Signals]: Map<string, Signal> }) {\n      const signals = (this[Signals] = this[Signals] || new Map());\n      const existing = signals.has(key);\n      const _signal = entangleSignal(signals, this, key);\n      if (!existing && v !== undefined) {\n        _signal.lastValue = v;\n      }\n      return _signal.lastValue;\n    },\n    set(this: T & { [Signals]: Map<string, Signal> }, value: unknown) {\n      const signals = (this[Signals] = this[Signals] || new Map());\n      let _signal = signals.get(key);\n      if (!_signal) {\n        _signal = createSignal(this, key);\n        signals.set(key, _signal);\n      }\n      if (_signal.lastValue !== value) {\n        _signal.lastValue = value;\n        addToTransaction(_signal);\n      }\n    },\n  });\n}\n\nexport interface Signal {\n  /**\n   * Key on the associated object\n   * @internal\n   */\n  key: string;\n  _debug_base?: string;\n\n  /**\n   * Whether this signal is part of an active transaction.\n   * @internal\n   */\n  t: boolean;\n\n  /**\n   * Whether to \"bust\" the lastValue cache\n   * @internal\n   */\n  shouldReset: boolean;\n\n  /**\n   * The framework specific \"signal\" e.g. glimmer \"tracked\"\n   * or starbeam \"cell\" to consume/invalidate when appropriate.\n   *\n   * @internal\n   */\n  tag: ReturnType<typeof tagForProperty>;\n\n  /**\n   * In classic ember, arrays must entangle a `[]` symbol\n   * in addition to any other tag in order for array chains to work.\n   *\n   * Note, this symbol MUST be the one that ember itself generates\n   *\n   * @internal\n   */\n  '[]': ReturnType<typeof tagForProperty> | null;\n  /**\n   * In classic ember, arrays must entangle a `@length` symbol\n   * in addition to any other tag in order for array chains to work.\n   *\n   * Note, this symbol MUST be the one that ember itself generates\n   *\n   * @internal\n   */\n  '@length': ReturnType<typeof tagForProperty> | null;\n\n  /**\n   * The lastValue computed for this signal when\n   * a signal is also used for storage.\n   * @internal\n   */\n  lastValue: unknown;\n}\n\nexport function createArrayTags<T extends object>(obj: T, signal: Signal) {\n  if (DEPRECATE_COMPUTED_CHAINS) {\n    signal['[]'] = tagForProperty(obj, '[]');\n    signal['@length'] = tagForProperty(obj, 'length');\n  }\n}\n\n/**\n * Create a signal for the key/object pairing.\n *\n * @internal\n * @param obj Object we're creating the signal on\n * @param key Key to create the signal for\n * @return the signal\n */\nexport function createSignal<T extends object>(obj: T, key: string): Signal {\n  const _signal: Signal = {\n    key,\n    tag: tagForProperty(obj, key),\n\n    t: false,\n    shouldReset: false,\n    '[]': null,\n    '@length': null,\n    lastValue: undefined,\n  };\n\n  if (DEBUG) {\n    function tryGet<T1 = string>(prop: string): T1 | undefined {\n      try {\n        return obj[prop as keyof typeof obj] as unknown as T1;\n      } catch {\n        return;\n      }\n    }\n    const modelName =\n      tryGet('$type') ?? tryGet('modelName') ?? tryGet<{ modelName?: string }>('constructor')?.modelName ?? '';\n\n    const className = obj.constructor?.name ?? obj.toString?.() ?? 'unknown';\n    _signal._debug_base = `${className}${modelName && !className.startsWith('SchemaRecord') ? `:${modelName}` : ''}`;\n  }\n\n  return _signal;\n}\n\n/**\n * Create a signal for the key/object pairing and subscribes to the signal.\n *\n * Use when you need to ensure a signal exists and is subscribed to.\n *\n * @internal\n * @param signals Map of signals\n * @param obj Object we're creating the signal on\n * @param key Key to create the signal for\n * @return the signal\n */\nexport function entangleSignal<T extends object>(signals: Map<string, Signal>, obj: T, key: string): Signal {\n  let _signal = signals.get(key);\n  if (!_signal) {\n    _signal = createSignal(obj, key);\n    signals.set(key, _signal);\n  }\n  subscribe(_signal);\n  return _signal;\n}\n\ninterface Signaler {\n  [Signals]: Map<string, Signal>;\n}\n\nexport function getSignal<T extends object>(obj: T, key: string, initialState: boolean): Signal {\n  let signals = (obj as Signaler)[Signals];\n\n  if (!signals) {\n    signals = new Map();\n    (obj as Signaler)[Signals] = signals;\n  }\n\n  let _signal = signals.get(key);\n  if (!_signal) {\n    _signal = createSignal(obj, key);\n    _signal.shouldReset = initialState;\n    signals.set(key, _signal);\n  }\n  return _signal;\n}\n\nexport function peekSignal<T extends object>(obj: T, key: string): Signal | undefined {\n  const signals = (obj as Signaler)[Signals];\n  if (signals) {\n    return signals.get(key);\n  }\n}\n"],"names":["createTransaction","transaction","cbs","Set","props","sub","parent","TRANSACTION","peekTransient","setTransient","maybeConsume","tag","consumeTag","maybeDirty","dirtyTag","subscribe","obj","add","macroCondition","getGlobalConfig","WarpDrive","deprecations","DEPRECATE_COMPUTED_CHAINS","ref","updateRef","env","DEBUG","e","Error","message","includes","key","_debug_base","replace","stack","lines","split","finalLines","lastFile","forEach","line","trim","startsWith","location","at","parts","pop","file","join","push","splitstr","splice","flushTransaction","cb","t","untrack","Promise","resolve","addToTransaction","addTransactionCB","method","untracked","ret","transact","memoTransact","args","Signals","getOrSetGlobal","Symbol","defineSignal","v","Object","defineProperty","enumerable","configurable","get","signals","Map","existing","has","_signal","entangleSignal","undefined","lastValue","set","value","createSignal","createArrayTags","signal","tagForProperty","shouldReset","tryGet","prop","modelName","className","constructor","name","toString","getSignal","initialState","peekSignal"],"mappings":"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"}