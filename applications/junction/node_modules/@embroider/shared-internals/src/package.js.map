{"version":3,"file":"package.js","sourceRoot":"","sources":["package.ts"],"names":[],"mappings":"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","sourcesContent":["import { Memoize } from 'typescript-memoize';\nimport { readFileSync, existsSync } from 'fs-extra';\nimport { join, extname } from 'path';\nimport get from 'lodash/get';\nimport type { AddonMeta, PackageInfo } from './metadata';\nimport type PackageCache from './package-cache';\nimport flatMap from 'lodash/flatMap';\n\n// This is controllable via env var because there are many different contexts\n// (babel/rollup/vite/webpack/handlebars plugins) that can all depend on\n// `@embroider/shared-internals` to help understand the structure of packages,\n// and we want one clear way to signal to all of those whether this feature is\n// configured.\n//\n// The initial motivating use case for this is that new-enough ember-source can\n// function as a v2 addon despite not declaring itself to be a v2 addon, because\n// that would be potentially-breaking for people who still consume it via AMD\n// and/or depend on the specific timng of the classic vendor.js file. We don't\n// want to break people but we also want people on the bleeding edge to be able\n// to take advantage of the capability.\nconst forcedV2Packages = (() => {\n  let cached: string[] | undefined;\n  return () => {\n    if (!cached) {\n      if (\n        typeof process !== undefined &&\n        typeof process.env !== undefined &&\n        process.env.EMBROIDER_FORCED_V2_PACKAGES\n      ) {\n        cached = process.env.EMBROIDER_FORCED_V2_PACKAGES.split(',');\n      } else {\n        cached = [];\n      }\n    }\n    return cached;\n  };\n})();\n\nexport default class Package {\n  // order here matters because we rely on it in categorizeDependency\n  private dependencyKeys: ('dependencies' | 'devDependencies' | 'peerDependencies')[];\n\n  constructor(readonly root: string, protected packageCache: PackageCache, private _isApp: boolean) {\n    this.dependencyKeys = _isApp\n      ? ['dependencies', 'devDependencies', 'peerDependencies']\n      : ['dependencies', 'peerDependencies'];\n  }\n\n  get name(): string {\n    return this.packageJSON.name;\n  }\n\n  get version(): string {\n    return this.packageJSON.version;\n  }\n\n  @Memoize()\n  protected get internalPackageJSON() {\n    return JSON.parse(readFileSync(join(this.root, 'package.json'), 'utf8'));\n  }\n\n  @Memoize()\n  get packageJSON(): PackageInfo {\n    let json = this.internalPackageJSON;\n    if (this.nonResolvableDeps) {\n      if (!json.dependencies) {\n        json.dependencies = {};\n      }\n      for (let dep of this.nonResolvableDeps.values()) {\n        json.dependencies[dep.name] = dep.version || '*';\n      }\n    }\n    if (forcedV2Packages().includes(json.name)) {\n      let defaults: AddonMeta = {\n        version: 2,\n      };\n      json['ember-addon'] = Object.assign(defaults, json['ember-addon']);\n    }\n    return json;\n  }\n\n  get meta(): AddonMeta | undefined {\n    let m = this.packageJSON['ember-addon'];\n    if (this.isV2Addon()) {\n      return m as AddonMeta;\n    }\n  }\n\n  isEmberAddon(): boolean {\n    let keywords = this.packageJSON.keywords;\n    return Boolean(keywords && (keywords as string[]).includes('ember-addon'));\n  }\n\n  isEngine(): boolean {\n    if (this.isApp()) {\n      // an app is implicitly an engine\n      return true;\n    }\n    let keywords = this.packageJSON.keywords;\n    return Boolean(keywords && (keywords as string[]).includes('ember-engine'));\n  }\n\n  isLazyEngine(): boolean {\n    return this.isEngine() && Boolean(get(this.packageJSON, 'ember-addon.lazy-engine'));\n  }\n\n  isV2Ember(): boolean {\n    return this.isApp() || this.isV2Addon();\n  }\n\n  isApp(): boolean {\n    return this._isApp;\n  }\n\n  needsLooseResolving(): boolean {\n    return this.isApp() || ((this.isV2Addon() && this.meta['auto-upgraded']) ?? false);\n  }\n\n  isV2Addon(): this is V2AddonPackage {\n    return this.isEmberAddon() && this.packageJSON['ember-addon']?.version === 2;\n  }\n\n  findDescendants(filter?: (pkg: Package) => boolean): Package[] {\n    let pkgs = new Set<Package>();\n    let queue: Package[] = [this];\n    while (true) {\n      let pkg = queue.shift();\n      if (!pkg) {\n        break;\n      }\n      if (!pkgs.has(pkg)) {\n        pkgs.add(pkg);\n        let nextLevel;\n        if (filter) {\n          nextLevel = pkg.dependencies.filter(filter);\n        } else {\n          nextLevel = pkg.dependencies;\n        }\n        nextLevel.forEach(d => queue.push(d));\n      }\n    }\n    pkgs.delete(this);\n    return [...pkgs.values()];\n  }\n\n  get mayRebuild(): boolean {\n    // if broccoli memoization is enabled, allowing addons to rebuild\n    // automatically is cheap, so we allow all addons to rebuild.\n    if (process.env['BROCCOLI_ENABLED_MEMOIZE'] === 'true') {\n      return true;\n    }\n\n    // Otherwise, we only allow addons to rebuild that you've explicitly asked for\n    // via env var.\n    if (process.env.EMBROIDER_REBUILD_ADDONS) {\n      if (process.env.EMBROIDER_REBUILD_ADDONS.split(',').includes(this.name)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  @Memoize()\n  get nonResolvableDeps(): Map<string, Package> | undefined {\n    let meta = this.internalPackageJSON['ember-addon'];\n    if (meta && meta.paths) {\n      return new Map(\n        meta.paths\n          .map((path: string) => {\n            // ember-cli gives a warning if the path specifies an invalid, malformed or missing addon. the logic for invalidating an addon is:\n            // https://github.com/ember-cli/ember-cli/blob/627934f91b2aa0e19b041fdb1b547873c1855793/lib/models/package-info-cache/index.js#L427\n            //\n            // Note that we only need to be this lenient with in-repo addons,\n            // which is why this logic is here in nonResolvableDeps. If you try\n            // to ship broken stuff in regular dependencies, NPM is going to\n            // stop you.\n            let pkg, main;\n            try {\n              pkg = this.packageCache.get(join(this.root, path));\n              main = pkg.packageJSON['ember-addon']?.main || pkg.packageJSON['main'];\n            } catch (err) {\n              // package was missing or had invalid package.json\n              return false;\n            }\n\n            if (!main || main === '.' || main === './') {\n              main = 'index.js';\n            } else if (!extname(main)) {\n              main = `${main}.js`;\n            }\n\n            let mainPath = join(this.root, path, main);\n            if (!existsSync(mainPath)) {\n              // package has no valid main\n              return false;\n            }\n            return [pkg.name, pkg];\n          })\n          .filter(Boolean)\n      );\n    }\n  }\n\n  get dependencyNames(): string[] {\n    return flatMap(this.dependencyKeys, key => Object.keys(this.packageJSON[key] || {}));\n  }\n\n  // this answers the question, \"why is this thing in `this.dependencies`?\". The\n  // order of the dependency keys is important, because \"dependencies\" always\n  // dominates (if it's your dependency, it's always your dependency). Next\n  // comes devDependencies, so that if you're the topmost package, your\n  // devDependencies are active dependenceis. Last comes peerDependencies. It's\n  // common for a peerDep to also appear in devDependencies, but unless your\n  // pacakge is the topmost your devDependencies won't be included in\n  // this.dependencyKeys, so we'll see that you are now getting the package via\n  // peerDeps.\n  categorizeDependency(name: string) {\n    for (let key of this.dependencyKeys) {\n      if (this.packageJSON[key]?.[name]) {\n        return key;\n      }\n    }\n  }\n\n  @Memoize()\n  get dependencies(): Package[] {\n    return this.dependencyNames\n      .map(name => {\n        if (this.nonResolvableDeps) {\n          let dep = this.nonResolvableDeps.get(name);\n          if (dep) {\n            return dep;\n          }\n        }\n        try {\n          return this.packageCache.resolve(name, this);\n        } catch (error) {\n          // if the package was not found do not error out here. this is relevant\n          // for the case where a package might be an optional peerDependency and we dont\n          // want to error if it was not found. Additionally, erroring here is \"far\" away\n          // from the actual logical failure point and so not failing here will provide a better\n          // error message down the line\n          if (error.code === 'MODULE_NOT_FOUND') {\n            return false;\n          }\n\n          throw error;\n        }\n      })\n      .filter(Boolean) as Package[];\n  }\n\n  hasDependency(name: string): boolean {\n    for (let section of this.dependencyKeys) {\n      if (this.packageJSON[section]) {\n        if ((this.packageJSON[section] as Record<string, string>)[name]) {\n          return true;\n        }\n      }\n    }\n    return false;\n  }\n}\n\nexport interface PackageConstructor {\n  new (root: string, mayUseDevDeps: boolean, packageCache: PackageCache): Package;\n}\n\nexport interface V2AddonPackage extends Package {\n  meta: AddonMeta;\n}\n"]}